# GitHub Actions CI/CD - Deploy to DigitalOcean Droplet
# Trigger: push to vegaah-to-instamojo and india-2-manage-gmail
# Deploys backend (PM2) + frontend (npm build)

name: Deploy to Production Samjhona Website

on:
  push:
    branches:
      - india-2-manage-gmail

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    env:
      SERVER_IP: ${{ secrets.SERVER_IP }}
      SERVER_USER: ${{ secrets.SERVER_USER }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Setup SSH
        run: |
          set -e
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.SERVER_IP }}" >> ~/.ssh/known_hosts 2>/dev/null
          chmod 644 ~/.ssh/known_hosts
          echo "âœ… SSH key and known_hosts configured"

      - name: ğŸš€ Deploy via SSH
        env:
          GITHUB_USER: ${{ secrets.USERNAME }}
          GITHUB_PAT: ${{ secrets.PAT_TOKEN }}
          GITHUB_REPO: ${{ github.repository }}
        run: |
          set -e
          echo "ğŸ“¡ Connecting to ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=yes -o UserKnownHostsFile=~/.ssh/known_hosts \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "set -e
            echo 'ğŸ“‚ cd /root/instaStalk'
            cd /root/instaStalk || { echo 'âŒ /root/instaStalk not found'; exit 1; }
            echo 'ğŸ”„ Configuring git remote for private repo...'
            git remote set-url origin https://${GITHUB_USER}:${GITHUB_PAT}@github.com/${GITHUB_REPO}.git 2>/dev/null || true
            echo 'â¬‡ï¸  git fetch and reset to vegaah-to-instamojo'
            git fetch origin vegaah-to-instamojo
            git reset --hard origin/vegaah-to-instamojo
            git clean -fd
            echo 'âœ… Git pull complete'
            echo 'ğŸ”„ pm2 restart all (backend)'
            pm2 restart all || { echo 'âš ï¸ pm2 restart failed (continuing)'; }
            echo 'âœ… PM2 restarted'
            echo 'ğŸ“‚ cd frontend'
            cd /root/instaStalk/frontend || { echo 'âŒ frontend dir not found'; exit 1; }
            echo 'ğŸ“¦ npm ci || npm install'
            npm ci 2>/dev/null || npm install
            echo 'âœ… Dependencies installed'
            echo 'ğŸ—ï¸  npm run build'
            npm run build
            echo 'âœ… Frontend build complete'
            echo 'ğŸ‰ Deployment finished successfully'"

      - name: ğŸ§¹ Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          echo "âœ… Deploy key removed"